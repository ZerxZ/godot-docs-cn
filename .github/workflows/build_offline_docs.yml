name: Build documentation for offline usage
on:
  workflow_dispatch:
  schedule:
    # Every week on Monday at midnight (UTC).
    # This keeps the generated HTML documentation fresh.
    - cron: '0 0 * * 1'
permissions: write-all
  
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4.1.1
      - name: Checkout Godot
        uses: actions/checkout@v4
        with:
            repository: godotengine/godot-docs-l10n
            ref: 4.x
            submodules: 'recursive'
            path: 'godot-docs'
      - name: Install dependencies
        run: |
          cd godot-docs
          sudo pip3 install -r docs/requirements.txt
          sudo pip3 install codespell
          sudo apt update
          sudo apt install parallel libwebp7

      - name: Sphinx - Build HTML
        run: |
          cd godot-docs
          python -m sphinx -T -b html -d _build/doctrees -D language=zh_CN ./docs  ../dist
      - uses: actions/upload-artifact@v4
        with:
          name: godot-docs-html-cn
          path: dist
          # Keep the current build and the previous build (in case a scheduled build failed).
          # This makes it more likely to have at least one successful build available at all times.
          retention-days: 15
      - name: Commit files
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A .
          git commit -a -m "更新翻译"
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
          force: true
      
