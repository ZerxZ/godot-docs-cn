name: Build documentation for offline usage
on:
  workflow_dispatch:
  # schedule:
    # Every week on Monday at midnight (UTC).
    # This keeps the generated HTML documentation fresh.
    # - cron: '0 0 * * 1'


jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      READTHEDOCS_LANGUAGE: 'zh_CN'
      SPHINX_TAGS: "i18n"
    name: ðŸ“š Build offline documentation
    permissions: # Job-level permissions configuration starts here
      contents: write           # 'write' access to repository contents
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal access token.
          fetch-depth: 0 # otherwise, there would be errors pushing refs to the destination repository.
      - name: Checkout Godot
        uses: actions/checkout@v4
        with:
          repository: godotengine/godot-docs-l10n
          ref: 4.x
          submodules: 'recursive'
          path: 'godot-docs'
      - name: Install dependencies
        run: |
          sudo rm -rf ./dist
          sudo rm -rf ./xml
          cd godot-docs
          sudo pip3 install -r docs/requirements.txt
          sudo pip3 install codespell
          sudo apt update
          sudo apt install parallel libwebp7

      - name: Sphinx - Build HTML
        run: |
          cd godot-docs
          python -m sphinx -T -b html -d _build/doctrees -D language=zh_CN ./docs  ../dist
      - name: Sphinx - Build XML
        run: |
          cd godot-docs
          python -m sphinx -T -b xml -d _build/doctrees -D language=zh_CN ./docs  ../xml
      - name: Zip HTML/XML
        run: |
         sudo zip -r godotâ€“docs-html.zip dist
         sudo zip -r godotâ€“docs-xml.zip xml
         
      - uses: actions/upload-artifact@v4
        with:
          name: godot-docs-html
          path: dist
          # Keep the current build and the previous build (in case a scheduled build failed).
          # This makes it more likely to have at least one successful build available at all times.
          retention-days: 15
      - uses: actions/upload-artifact@v4
        with:
          name: docs-html
          path: ./godotâ€“docs-html.zip
          # Keep the current build and the previous build (in case a scheduled build failed).
          # This makes it more likely to have at least one successful build available at all times.
          retention-days: 15
      - uses: actions/upload-artifact@v4
        with:
          name: docs-xml
          path: ./godotâ€“docs-xml.zip
          # Keep the current build and the previous build (in case a scheduled build failed).
          # This makes it more likely to have at least one successful build available at all times.
          retention-days: 15
      - name: Remove HTML/XML
        run: |
          ls -R
          sudo rm -f godotâ€“docs-html.zip
          sudo rm -f godotâ€“docs-xml.zip 
      - name: Commit files
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A .
          git commit -a -m "æ›´æ–°ç¿»è¯‘"
        continue-on-error: true
        
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          continue-on-error: true
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
          tags: true
          force: true
  release:
    needs: [ build ]
    name: ðŸš€ Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.1.1
      - name: Download Godot Artifact
        uses: actions/download-artifact@v4.1.4
        with:
          pattern: 'docs-*'
          merge-multiple: true
      - name: Set Release version env variable
        id: release-selector
        run: |
          echo "RELEASE_VERSION=$(date "+%y.%m.%d")" >> $GITHUB_OUTPUT
      - name: Automatic Pre Releases
        uses: ncipollo/release-action@v1.14.0
        with:
          tag: "latest"
          name: "Latest Release ${{ env.RELEASE_VERSION }}"
          allowUpdates: true
          artifacts: |
            *.zip
