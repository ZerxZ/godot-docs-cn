<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE document PUBLIC "+//IDN docutils.sourceforge.net//DTD Docutils Generic//EN//XML" "http://docutils.sourceforge.net/docs/ref/docutils.dtd">
<!-- Generated by Docutils 0.21.2 -->
<document source="/home/runner/work/godot-docs-cn/godot-docs-cn/godot-docs/docs/engine_details/architecture/custom_resource_format_loaders.rst" translation_progress="{'total': 0, 'translated': 0}" xmlns:c="https://www.sphinx-doc.org/" xmlns:changeset="https://www.sphinx-doc.org/" xmlns:citation="https://www.sphinx-doc.org/" xmlns:cpp="https://www.sphinx-doc.org/" xmlns:index="https://www.sphinx-doc.org/" xmlns:js="https://www.sphinx-doc.org/" xmlns:math="https://www.sphinx-doc.org/" xmlns:py="https://www.sphinx-doc.org/" xmlns:rst="https://www.sphinx-doc.org/" xmlns:std="https://www.sphinx-doc.org/">
    <target refid="doc-custom-resource-format-loaders"></target>
    <section ids="custom-resource-format-loaders doc-custom-resource-format-loaders" names="custom\ resource\ format\ loaders doc_custom_resource_format_loaders">
        <title>Custom resource format loaders</title>
        <section ids="introduction" names="introduction">
            <title>Introduction</title>
            <paragraph>ResourceFormatLoader is a factory interface for loading file assets.
                Resources are primary containers. When load is called on the same file
                path again, the previous loaded Resource will be referenced. Naturally,
                loaded resources must be stateless.</paragraph>
            <paragraph>This guide assumes the reader knows how to create C++ modules and Godot
                data types. If not, refer to this guide: <reference internal="True" refuri="custom_modules_in_cpp#doc-custom-modules-in-cpp"><inline classes="std std-ref">Custom modules in C++</inline></reference></paragraph>
            <section dupnames="references" ids="references">
                <title>References</title>
                <bullet_list bullet="-">
                    <list_item>
                        <paragraph><reference internal="True" refuri="../../classes/class_resourceloader#class-resourceloader"><inline classes="std std-ref">ResourceLoader</inline></reference></paragraph>
                    </list_item>
                    <list_item>
                        <paragraph><reference name="core/io/resource_loader.cpp" refuri="https://github.com/godotengine/godot/blob/master/core/io/resource_loader.cpp">core/io/resource_loader.cpp</reference><target ids="core-io-resource-loader-cpp" names="core/io/resource_loader.cpp" refuri="https://github.com/godotengine/godot/blob/master/core/io/resource_loader.cpp"></target></paragraph>
                    </list_item>
                </bullet_list>
            </section>
        </section>
        <section ids="what-for" names="what\ for?">
            <title>What for?</title>
            <bullet_list bullet="-">
                <list_item>
                    <paragraph>Adding new support for many file formats</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Audio formats</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Video formats</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Machine learning models</paragraph>
                </list_item>
            </bullet_list>
        </section>
        <section ids="what-not" names="what\ not?">
            <title>What not?</title>
            <bullet_list bullet="-">
                <list_item>
                    <paragraph>Raster images</paragraph>
                </list_item>
            </bullet_list>
            <paragraph>ImageFormatLoader should be used to load images.</paragraph>
            <section dupnames="references" ids="id1">
                <title>References</title>
                <bullet_list bullet="-">
                    <list_item>
                        <paragraph><reference name="core/io/image_loader.h" refuri="https://github.com/godotengine/godot/blob/master/core/io/image_loader.h">core/io/image_loader.h</reference><target ids="core-io-image-loader-h" names="core/io/image_loader.h" refuri="https://github.com/godotengine/godot/blob/master/core/io/image_loader.h"></target></paragraph>
                    </list_item>
                </bullet_list>
            </section>
        </section>
        <section ids="creating-a-resourceformatloader" names="creating\ a\ resourceformatloader">
            <title>Creating a ResourceFormatLoader</title>
            <paragraph>Each file format consist of a data container and a <literal>ResourceFormatLoader</literal>.</paragraph>
            <paragraph>ResourceFormatLoaders are classes which return all the
                necessary metadata for supporting new extensions in Godot. The
                class must return the format name and the extension string.</paragraph>
            <paragraph>In addition, ResourceFormatLoaders must convert file paths into
                resources with the <literal>load</literal> function. To load a resource, <literal>load</literal> must
                read and handle data serialization.</paragraph>
            <container classes="literal-block-wrapper" ids="id5" literal_block="True">
                <caption>resource_loader_json.h</caption>
                <literal_block force="False" highlight_args="{}" language="cpp" linenos="False" xml:space="preserve">#pragma once

#include "core/io/resource_loader.h"

class ResourceFormatLoaderJson : public ResourceFormatLoader {
    GDCLASS(ResourceFormatLoaderJson, ResourceFormatLoader);
public:
    virtual RES load(const String &amp;p_path, const String &amp;p_original_path, Error *r_error = NULL);
    virtual void get_recognized_extensions(List&lt;String&gt; *r_extensions) const;
    virtual bool handles_type(const String &amp;p_type) const;
    virtual String get_resource_type(const String &amp;p_path) const;
};</literal_block>
            </container>
            <container classes="literal-block-wrapper" ids="id6" literal_block="True">
                <caption>resource_loader_json.cpp</caption>
                <literal_block force="False" highlight_args="{}" language="cpp" linenos="False" xml:space="preserve">#include "resource_loader_json.h"

#include "resource_json.h"

RES ResourceFormatLoaderJson::load(const String &amp;p_path, const String &amp;p_original_path, Error *r_error) {
Ref&lt;JsonResource&gt; json = memnew(JsonResource);
    if (r_error) {
        *r_error = OK;
    }
    Error err = json-&gt;load_file(p_path);
    return json;
}

void ResourceFormatLoaderJson::get_recognized_extensions(List&lt;String&gt; *r_extensions) const {
    if (!r_extensions-&gt;find("json")) {
        r_extensions-&gt;push_back("json");
    }
}

String ResourceFormatLoaderJson::get_resource_type(const String &amp;p_path) const {
    return "Resource";
}

bool ResourceFormatLoaderJson::handles_type(const String &amp;p_type) const {
    return ClassDB::is_parent_class(p_type, "Resource");
}</literal_block>
            </container>
        </section>
        <section ids="creating-a-resourceformatsaver" names="creating\ a\ resourceformatsaver">
            <title>Creating a ResourceFormatSaver</title>
            <paragraph>If you'd like to be able to edit and save a resource, you can implement a
                <literal>ResourceFormatSaver</literal>:</paragraph>
            <container classes="literal-block-wrapper" ids="id7" literal_block="True">
                <caption>resource_saver_json.h</caption>
                <literal_block force="False" highlight_args="{}" language="cpp" linenos="False" xml:space="preserve">#pragma once

#include "core/io/resource_saver.h"

class ResourceFormatSaverJson : public ResourceFormatSaver {
    GDCLASS(ResourceFormatSaverJson, ResourceFormatSaver);
public:
    virtual Error save(const String &amp;p_path, const RES &amp;p_resource, uint32_t p_flags = 0);
    virtual bool recognize(const RES &amp;p_resource) const;
    virtual void get_recognized_extensions(const RES &amp;p_resource, List&lt;String&gt; *r_extensions) const;
};</literal_block>
            </container>
            <container classes="literal-block-wrapper" ids="id8" literal_block="True">
                <caption>resource_saver_json.cpp</caption>
                <literal_block force="False" highlight_args="{}" language="cpp" linenos="False" xml:space="preserve">#include "resource_saver_json.h"

#include "resource_json.h"
#include "scene/resources/resource_format_text.h"

Error ResourceFormatSaverJson::save(const String &amp;p_path, const RES &amp;p_resource, uint32_t p_flags) {
    Ref&lt;JsonResource&gt; json = memnew(JsonResource);
    Error error = json-&gt;save_file(p_path, p_resource);
    return error;
}

bool ResourceFormatSaverJson::recognize(const RES &amp;p_resource) const {
    return Object::cast_to&lt;JsonResource&gt;(*p_resource) != NULL;
}

void ResourceFormatSaverJson::get_recognized_extensions(const RES &amp;p_resource, List&lt;String&gt; *r_extensions) const {
    if (Object::cast_to&lt;JsonResource&gt;(*p_resource)) {
        r_extensions-&gt;push_back("json");
    }
}</literal_block>
            </container>
        </section>
        <section ids="creating-custom-data-types" names="creating\ custom\ data\ types">
            <title>Creating custom data types</title>
            <paragraph>Godot may not have a proper substitute within its <reference internal="True" refuri="core_types#doc-core-types"><inline classes="std std-ref">Core types</inline></reference>
                or managed resources. Godot needs a new registered data type to
                understand additional binary formats such as machine learning models.</paragraph>
            <paragraph>Here is an example of creating a custom datatype:</paragraph>
            <container classes="literal-block-wrapper" ids="id9" literal_block="True">
                <caption>resource_json.h</caption>
                <literal_block force="False" highlight_args="{}" language="cpp" linenos="False" xml:space="preserve">#pragma once

#include "core/io/json.h"
#include "core/variant_parser.h"

class JsonResource : public Resource {
    GDCLASS(JsonResource, Resource);

protected:
    static void _bind_methods() {
        ClassDB::bind_method(D_METHOD("set_dict", "dict"), &amp;JsonResource::set_dict);
        ClassDB::bind_method(D_METHOD("get_dict"), &amp;JsonResource::get_dict);

        ADD_PROPERTY(PropertyInfo(Variant::DICTIONARY, "content"), "set_dict", "get_dict");
    }

private:
    Dictionary content;

public:
    Error load_file(const String &amp;p_path);
    Error save_file(const String &amp;p_path, const RES &amp;p_resource);

    void set_dict(const Dictionary &amp;p_dict);
    Dictionary get_dict();
};</literal_block>
            </container>
            <container classes="literal-block-wrapper" ids="id10" literal_block="True">
                <caption>resource_json.cpp</caption>
                <literal_block force="False" highlight_args="{}" language="cpp" linenos="False" xml:space="preserve">#include "resource_json.h"

Error JsonResource::load_file(const String &amp;p_path) {
    Error error;
    FileAccess *file = FileAccess::open(p_path, FileAccess::READ, &amp;error);
    if (error != OK) {
        if (file) {
            file-&gt;close();
        }
        return error;
    }

    String json_string = String("");
    while (!file-&gt;eof_reached()) {
        json_string += file-&gt;get_line();
    }
    file-&gt;close();

    String error_string;
    int error_line;
    JSON json;
    Variant result;
    error = json.parse(json_string, result, error_string, error_line);
    if (error != OK) {
        file-&gt;close();
        return error;
    }

    content = Dictionary(result);
    return OK;
}

Error JsonResource::save_file(const String &amp;p_path, const RES &amp;p_resource) {
    Error error;
    FileAccess *file = FileAccess::open(p_path, FileAccess::WRITE, &amp;error);
    if (error != OK) {
        if (file) {
            file-&gt;close();
        }
        return error;
    }

    Ref&lt;JsonResource&gt; json_ref = p_resource.get_ref_ptr();
    JSON json;

    file-&gt;store_string(json.print(json_ref-&gt;get_dict(), "    "));
    file-&gt;close();
    return OK;
}

void JsonResource::set_dict(const Dictionary &amp;p_dict) {
    content = p_dict;
}

Dictionary JsonResource::get_dict() {
    return content;
}</literal_block>
            </container>
            <section ids="considerations" names="considerations">
                <title>Considerations</title>
                <paragraph>Some libraries may not define certain common routines such as IO handling.
                    Therefore, Godot call translations are required.</paragraph>
                <paragraph>For example, here is the code for translating <literal>FileAccess</literal>
                    calls into <literal>std::istream</literal>.</paragraph>
                <literal_block force="False" highlight_args="{}" language="cpp" linenos="False" xml:space="preserve">#include "core/io/file_access.h"

#include &lt;istream&gt;
#include &lt;streambuf&gt;

class GodotFileInStreamBuf : public std::streambuf {

public:
    GodotFileInStreamBuf(FileAccess *fa) {
        _file = fa;
    }
    int underflow() {
        if (_file-&gt;eof_reached()) {
            return EOF;
        } else {
            size_t pos = _file-&gt;get_position();
            uint8_t ret = _file-&gt;get_8();
            _file-&gt;seek(pos); // Required since get_8() advances the read head.
            return ret;
        }
    }
    int uflow() {
        return _file-&gt;eof_reached() ? EOF : _file-&gt;get_8();
    }

private:
    FileAccess *_file;
};</literal_block>
            </section>
            <section dupnames="references" ids="id2">
                <title>References</title>
                <bullet_list bullet="-">
                    <list_item>
                        <paragraph><reference name="istream" refuri="https://cplusplus.com/reference/istream/istream/">istream</reference><target ids="istream" names="istream" refuri="https://cplusplus.com/reference/istream/istream/"></target></paragraph>
                    </list_item>
                    <list_item>
                        <paragraph><reference name="streambuf" refuri="https://cplusplus.com/reference/streambuf/streambuf/?kw=streambuf">streambuf</reference><target ids="streambuf" names="streambuf" refuri="https://cplusplus.com/reference/streambuf/streambuf/?kw=streambuf"></target></paragraph>
                    </list_item>
                    <list_item>
                        <paragraph><reference name="core/io/file_access.h" refuri="https://github.com/godotengine/godot/blob/master/core/io/file_access.h">core/io/file_access.h</reference><target ids="core-io-file-access-h" names="core/io/file_access.h" refuri="https://github.com/godotengine/godot/blob/master/core/io/file_access.h"></target></paragraph>
                    </list_item>
                </bullet_list>
            </section>
        </section>
        <section ids="registering-the-new-file-format" names="registering\ the\ new\ file\ format">
            <title>Registering the new file format</title>
            <paragraph>Godot registers <literal>ResourcesFormatLoader</literal> with a <literal>ResourceLoader</literal>
                handler. The handler selects the proper loader automatically
                when <literal>load</literal> is called.</paragraph>
            <container classes="literal-block-wrapper" ids="id11" literal_block="True">
                <caption>register_types.h</caption>
                <literal_block force="False" highlight_args="{}" language="cpp" linenos="False" xml:space="preserve">void register_json_types();
void unregister_json_types();</literal_block>
            </container>
            <container classes="literal-block-wrapper" ids="id12" literal_block="True">
                <caption>register_types.cpp</caption>
                <literal_block force="False" highlight_args="{}" language="cpp" linenos="False" xml:space="preserve">#include "register_types.h"

#include "core/class_db.h"
#include "resource_loader_json.h"
#include "resource_saver_json.h"
#include "resource_json.h"

static Ref&lt;ResourceFormatLoaderJson&gt; json_loader;
static Ref&lt;ResourceFormatSaverJson&gt; json_saver;

void register_json_types() {
    ClassDB::register_class&lt;JsonResource&gt;();

    json_loader.instantiate();
    ResourceLoader::add_resource_format_loader(json_loader);

    json_saver.instantiate();
    ResourceSaver::add_resource_format_saver(json_saver);
}

void unregister_json_types() {
    ResourceLoader::remove_resource_format_loader(json_loader);
    json_loader.unref();

    ResourceSaver::remove_resource_format_saver(json_saver);
    json_saver.unref();
}</literal_block>
            </container>
            <section dupnames="references" ids="id3">
                <title>References</title>
                <bullet_list bullet="-">
                    <list_item>
                        <paragraph><reference name="core/io/resource_loader.cpp" refuri="https://github.com/godotengine/godot/blob/master/core/io/resource_loader.cpp">core/io/resource_loader.cpp</reference><target dupnames="core/io/resource_loader.cpp" ids="id4" refuri="https://github.com/godotengine/godot/blob/master/core/io/resource_loader.cpp"></target></paragraph>
                    </list_item>
                </bullet_list>
            </section>
        </section>
        <section ids="loading-it-on-gdscript" names="loading\ it\ on\ gdscript">
            <title>Loading it on GDScript</title>
            <paragraph>Save a file called <literal>demo.json</literal> with the following contents and place it in the
                project's root folder:</paragraph>
            <literal_block force="False" highlight_args="{}" language="json" linenos="False" xml:space="preserve">{
  "savefilename": "demo.json",
  "demo": [
    "welcome",
    "to",
    "godot",
    "resource",
    "loaders"
  ]
}</literal_block>
            <paragraph>Then attach the following script to any node:</paragraph>
            <literal_block force="False" language="gdscript" linenos="False" xml:space="preserve">extends Node

@onready var json_resource = load("res://demo.json")

func _ready():
    print(json_resource.get_dict())</literal_block>
            <substitution_definition names="weblate_widget"><reference refuri="https://hosted.weblate.org/engage/godot-engine/?utm_source=widget"><image alt="Translation status" candidates="{'?': 'https://hosted.weblate.org/widgets/godot-engine/-/godot-docs/287x66-white.png'}" height="66" uri="https://hosted.weblate.org/widgets/godot-engine/-/godot-docs/287x66-white.png" width="287"></image></reference></substitution_definition>
        </section>
    </section>
</document>
