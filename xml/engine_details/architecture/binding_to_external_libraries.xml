<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE document PUBLIC "+//IDN docutils.sourceforge.net//DTD Docutils Generic//EN//XML" "http://docutils.sourceforge.net/docs/ref/docutils.dtd">
<!-- Generated by Docutils 0.21.2 -->
<document source="/home/runner/work/godot-docs-cn/godot-docs-cn/godot-docs/docs/engine_details/architecture/binding_to_external_libraries.rst" translation_progress="{'total': 0, 'translated': 0}" xmlns:c="https://www.sphinx-doc.org/" xmlns:changeset="https://www.sphinx-doc.org/" xmlns:citation="https://www.sphinx-doc.org/" xmlns:cpp="https://www.sphinx-doc.org/" xmlns:index="https://www.sphinx-doc.org/" xmlns:js="https://www.sphinx-doc.org/" xmlns:math="https://www.sphinx-doc.org/" xmlns:py="https://www.sphinx-doc.org/" xmlns:rst="https://www.sphinx-doc.org/" xmlns:std="https://www.sphinx-doc.org/">
    <target refid="doc-binding-to-external-libraries"></target>
    <section ids="binding-to-external-libraries doc-binding-to-external-libraries" names="binding\ to\ external\ libraries doc_binding_to_external_libraries">
        <title>Binding to external libraries</title>
        <section ids="modules" names="modules">
            <title>Modules</title>
            <paragraph>The Summator example in <reference internal="True" refuri="custom_modules_in_cpp#doc-custom-modules-in-cpp"><inline classes="std std-ref">Custom modules in C++</inline></reference> is great for small,
                custom modules, but what if you want to use a larger, external library?
                Let's look at an example using <reference name="Festival" refuri="https://www.cstr.ed.ac.uk/projects/festival/">Festival</reference><target ids="festival" names="festival" refuri="https://www.cstr.ed.ac.uk/projects/festival/"></target>,
                a speech synthesis (text-to-speech) library written in C++.</paragraph>
            <paragraph>To bind to an external library, set up a module directory similar to the Summator example:</paragraph>
            <literal_block force="False" highlight_args="{}" language="none" linenos="False" xml:space="preserve">godot/modules/tts/</literal_block>
            <paragraph>Next, you will create a header file with a TTS class:</paragraph>
            <container classes="literal-block-wrapper" ids="id1" literal_block="True">
                <caption>godot/modules/tts/tts.h</caption>
                <literal_block force="False" highlight_args="{}" language="cpp" linenos="False" xml:space="preserve">#pragma once

#include "core/object/ref_counted.h"

class TTS : public RefCounted {
    GDCLASS(TTS, RefCounted);

protected:
    static void _bind_methods();

public:
    bool say_text(String p_txt);

    TTS();
};</literal_block>
            </container>
            <paragraph>And then you'll add the cpp file.</paragraph>
            <container classes="literal-block-wrapper" ids="id2" literal_block="True">
                <caption>godot/modules/tts/tts.cpp</caption>
                <literal_block force="False" highlight_args="{}" language="cpp" linenos="False" xml:space="preserve">#include "tts.h"

#include &lt;festival.h&gt;

bool TTS::say_text(String p_txt) {

    //convert Godot String to Godot CharString to C string
    return festival_say_text(p_txt.ascii().get_data());
}

void TTS::_bind_methods() {

    ClassDB::bind_method(D_METHOD("say_text", "txt"), &amp;TTS::say_text);
}

TTS::TTS() {
    festival_initialize(true, 210000); //not the best way to do it as this should only ever be called once.
}</literal_block>
            </container>
            <paragraph>Just as before, the new class needs to be registered somehow, so two more files
                need to be created:</paragraph>
            <literal_block force="False" highlight_args="{}" language="none" linenos="False" xml:space="preserve">register_types.h
register_types.cpp</literal_block>
            <important>
                <paragraph>These files must be in the top-level folder of your module (next to your
                    <literal>SCsub</literal> and <literal>config.py</literal> files) for the module to be registered properly.</paragraph>
            </important>
            <paragraph>These files should contain the following:</paragraph>
            <container classes="literal-block-wrapper" ids="id3" literal_block="True">
                <caption>godot/modules/tts/register_types.h</caption>
                <literal_block force="False" highlight_args="{}" language="cpp" linenos="False" xml:space="preserve">void initialize_tts_module(ModuleInitializationLevel p_level);
void uninitialize_tts_module(ModuleInitializationLevel p_level);
/* yes, the word in the middle must be the same as the module folder name */</literal_block>
            </container>
            <container classes="literal-block-wrapper" ids="id4" literal_block="True">
                <caption>godot/modules/tts/register_types.cpp</caption>
                <literal_block force="False" highlight_args="{}" language="cpp" linenos="False" xml:space="preserve">#include "register_types.h"

#include "core/object/class_db.h"
#include "tts.h"

void initialize_tts_module(ModuleInitializationLevel p_level) {
    if (p_level != MODULE_INITIALIZATION_LEVEL_SCENE) {
        return;
    }
    ClassDB::register_class&lt;TTS&gt;();
}

void uninitialize_tts_module(ModuleInitializationLevel p_level) {
    // Nothing to do here in this example.
}</literal_block>
            </container>
            <paragraph>Next, you need to create an <literal>SCsub</literal> file so the build system compiles
                this module:</paragraph>
            <container classes="literal-block-wrapper" ids="id5" literal_block="True">
                <caption>godot/modules/tts/SCsub</caption>
                <literal_block force="False" highlight_args="{}" language="python" linenos="False" xml:space="preserve">Import('env')

env_tts = env.Clone()
env_tts.add_source_files(env.modules_sources, "*.cpp") # Add all cpp files to the build</literal_block>
            </container>
            <paragraph>You'll need to install the external library on your machine to get the .a library files. See the library's official
                documentation for specific instructions on how to do this for your operation system. We've included the
                installation commands for Linux below, for reference.</paragraph>
            <literal_block force="False" highlight_args="{}" language="shell" linenos="False" xml:space="preserve">sudo apt-get install festival festival-dev  # Installs festival and speech_tools libraries
apt-cache search festvox-*  # Displays list of voice packages
sudo apt-get install festvox-don festvox-rablpc16k festvox-kallpc16k festvox-kdlpc16k  # Installs voices</literal_block>
            <important>
                <paragraph>The voices that Festival uses (and any other potential external/3rd-party
                    resource) all have varying licenses and terms of use; some (if not most) of them may be
                    be problematic with Godot, even if the Festival Library itself is MIT License compatible.
                    Please be sure to check the licenses and terms of use.</paragraph>
            </important>
            <paragraph>The external library will also need to be installed inside your module to make the source
                files accessible to the compiler, while also keeping the module code self-contained. The
                festival and speech_tools libraries can be installed from the modules/tts/ directory via
                git using the following commands:</paragraph>
            <literal_block force="False" highlight_args="{}" language="shell" linenos="False" xml:space="preserve">git clone https://github.com/festvox/festival
git clone https://github.com/festvox/speech_tools</literal_block>
            <paragraph>If you don't want the external repository source files committed to your repository, you
                can link to them instead by adding them as submodules (from within the modules/tts/ directory), as seen below:</paragraph>
            <literal_block force="False" highlight_args="{}" language="shell" linenos="False" xml:space="preserve">git submodule add https://github.com/festvox/festival
git submodule add https://github.com/festvox/speech_tools</literal_block>
            <important>
                <paragraph>Please note that Git submodules are not used in the Godot repository. If
                    you are developing a module to be merged into the main Godot repository, you should not
                    use submodules. If your module doesn't get merged in, you can always try to implement
                    the external library as a GDExtension.</paragraph>
            </important>
            <paragraph>To add include directories for the compiler to look at you can append it to the
                environment's paths:</paragraph>
            <container classes="literal-block-wrapper" ids="id6" literal_block="True">
                <caption>godot/modules/tts/SCsub</caption>
                <literal_block force="False" highlight_args="{}" language="python" linenos="False" xml:space="preserve"># These paths are relative to /modules/tts/
env_tts.Append(CPPPATH=["speech_tools/include", "festival/src/include"])

# LIBPATH and LIBS need to be set on the real "env" (not the clone)
# to link the specified libraries to the Godot executable.

# This is an absolute path where your .a libraries reside.
# If using a relative path, you must convert it to a
# full path using a utility function, such as `Dir('...').abspath`.
env.Append(LIBPATH=[Dir('libpath').abspath])

# Check with the documentation of the external library to see which library
# files should be included/linked.
env.Append(LIBS=['Festival', 'estools', 'estbase', 'eststring'])</literal_block>
            </container>
            <paragraph>If you want to add custom compiler flags when building your module, you need to clone
                <title_reference>env</title_reference> first, so it won't add those flags to whole Godot build (which can cause errors).
                Example <title_reference>SCsub</title_reference> with custom flags:</paragraph>
            <container classes="literal-block-wrapper" ids="id7" literal_block="True">
                <caption>godot/modules/tts/SCsub</caption>
                <literal_block force="False" highlight_args="{}" language="python" linenos="False" xml:space="preserve">Import('env')

env_tts = env.Clone()
env_tts.add_source_files(env.modules_sources, "*.cpp")
# Append CCFLAGS flags for both C and C++ code.
env_tts.Append(CCFLAGS=['-O2'])
# If you need to, you can:
# - Append CFLAGS for C code only.
# - Append CXXFLAGS for C++ code only.</literal_block>
            </container>
            <paragraph>The final module should look like this:</paragraph>
            <literal_block force="False" highlight_args="{}" language="none" linenos="False" xml:space="preserve">godot/modules/tts/festival/
godot/modules/tts/libpath/libestbase.a
godot/modules/tts/libpath/libestools.a
godot/modules/tts/libpath/libeststring.a
godot/modules/tts/libpath/libFestival.a
godot/modules/tts/speech_tools/
godot/modules/tts/config.py
godot/modules/tts/tts.h
godot/modules/tts/tts.cpp
godot/modules/tts/register_types.h
godot/modules/tts/register_types.cpp
godot/modules/tts/SCsub</literal_block>
        </section>
        <section ids="using-the-module" names="using\ the\ module">
            <title>Using the module</title>
            <paragraph>You can now use your newly created module from any script:</paragraph>
            <literal_block force="False" language="gdscript" linenos="False" xml:space="preserve">var t = TTS.new()
var script = "Hello world. This is a test!"
var is_spoken = t.say_text(script)
print('is_spoken: ', is_spoken)</literal_block>
            <paragraph>And the output will be <literal>is_spoken: True</literal> if the text is spoken.</paragraph>
            <substitution_definition names="weblate_widget"><reference refuri="https://hosted.weblate.org/engage/godot-engine/?utm_source=widget"><image alt="Translation status" candidates="{'?': 'https://hosted.weblate.org/widgets/godot-engine/-/godot-docs/287x66-white.png'}" height="66" uri="https://hosted.weblate.org/widgets/godot-engine/-/godot-docs/287x66-white.png" width="287"></image></reference></substitution_definition>
        </section>
    </section>
</document>
