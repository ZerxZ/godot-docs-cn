<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE document PUBLIC "+//IDN docutils.sourceforge.net//DTD Docutils Generic//EN//XML" "http://docutils.sourceforge.net/docs/ref/docutils.dtd">
<!-- Generated by Docutils 0.21.2 -->
<document source="/home/runner/work/godot-docs-cn/godot-docs-cn/godot-docs/docs/engine_details/development/handling_compatibility_breakages.rst" translation_progress="{'total': 0, 'translated': 0}" xmlns:c="https://www.sphinx-doc.org/" xmlns:changeset="https://www.sphinx-doc.org/" xmlns:citation="https://www.sphinx-doc.org/" xmlns:cpp="https://www.sphinx-doc.org/" xmlns:index="https://www.sphinx-doc.org/" xmlns:js="https://www.sphinx-doc.org/" xmlns:math="https://www.sphinx-doc.org/" xmlns:py="https://www.sphinx-doc.org/" xmlns:rst="https://www.sphinx-doc.org/" xmlns:std="https://www.sphinx-doc.org/">
    <target refid="doc-handling-compatibility-breakages"></target>
    <section ids="handling-compatibility-breakages doc-handling-compatibility-breakages" names="handling\ compatibility\ breakages doc_handling_compatibility_breakages">
        <title>Handling compatibility breakages</title>
        <comment xml:space="preserve">TODO: Elaborate on types of compatibility and procedure.</comment>
        <paragraph>So you've added a new parameter to a method, changed the return type,
            changed the type of a parameter, or changed its default value,
            and now the automated testing is complaining about compatibility breakages?</paragraph>
        <paragraph>Breaking compatibility should be avoided, but when necessary there are systems in place
            to handle this in a way that makes the transition as smooth as possible.</paragraph>
        <section ids="a-practical-example" names="a\ practical\ example">
            <title>A practical example</title>
            <comment xml:space="preserve">TODO: Add example that showcases more details like original default arguments etc.</comment>
            <paragraph>These changes are taken from <reference name="pull request #88047" refuri="https://github.com/godotengine/godot/pull/88047">pull request #88047</reference><target ids="pull-request-88047" names="pull\ request\ #88047" refuri="https://github.com/godotengine/godot/pull/88047"></target>, which added
                new pathing options to <literal>AStarGrid2D</literal> and other AStar classes.
                Among other changes, these methods were modified in <literal>core/math/a_star_grid_2d.h</literal>:</paragraph>
            <literal_block force="False" highlight_args="{}" language="cpp" linenos="False" xml:space="preserve">Vector&lt;Vector2&gt; get_point_path(const Vector2i &amp;p_from, const Vector2i &amp;p_to);
TypedArray&lt;Vector2i&gt; get_id_path(const Vector2i &amp;p_from, const Vector2i &amp;p_to);</literal_block>
            <paragraph>To:</paragraph>
            <literal_block force="False" highlight_args="{}" language="cpp" linenos="False" xml:space="preserve">Vector&lt;Vector2&gt; get_point_path(const Vector2i &amp;p_from, const Vector2i &amp;p_to, bool p_allow_partial_path = false);
TypedArray&lt;Vector2i&gt; get_id_path(const Vector2i &amp;p_from, const Vector2i &amp;p_to, bool p_allow_partial_path = false);</literal_block>
            <paragraph>This meant adding new compatibility method bindings to the file, which should be in the <literal>protected</literal> section of
                the code, usually placed next to <literal>_bind_methods()</literal>:</paragraph>
            <literal_block force="False" highlight_args="{}" language="cpp" linenos="False" xml:space="preserve">#ifndef DISABLE_DEPRECATED
    TypedArray&lt;Vector2i&gt; _get_id_path_bind_compat_88047(const Vector2i &amp;p_from, const Vector2i &amp;p_to);
    Vector&lt;Vector2&gt; _get_point_path_bind_compat_88047(const Vector2i &amp;p_from, const Vector2i &amp;p_to);
    static void _bind_compatibility_methods();
#endif</literal_block>
            <paragraph>They should start with an <literal>_</literal> to indicate that they are internal, and end with <literal>_bind_compat_</literal> followed by the PR number
                that introduced the change (<literal>88047</literal> in this example). These compatibility methods need to be implemented in a dedicated file,
                like <literal>core/math/a_star_grid_2d.compat.inc</literal> in this case:</paragraph>
            <container classes="literal-block-wrapper" ids="id1" literal_block="True">
                <caption>core/math/a_star_grid_2d.compat.inc</caption>
                <literal_block force="False" highlight_args="{}" language="cpp" linenos="False" xml:space="preserve">/**************************************************************************/
/*  a_star_grid_2d.compat.inc                                             */
/**************************************************************************/
/*                         This file is part of:                          */
/*                             GODOT ENGINE                               */
/*                        https://godotengine.org                         */
/**************************************************************************/
/* Copyright (c) 2014-present Godot Engine contributors (see AUTHORS.md). */
/* Copyright (c) 2007-2014 Juan Linietsky, Ariel Manzur.                  */
/*                                                                        */
/* Permission is hereby granted, free of charge, to any person obtaining  */
/* a copy of this software and associated documentation files (the        */
/* "Software"), to deal in the Software without restriction, including    */
/* without limitation the rights to use, copy, modify, merge, publish,    */
/* distribute, sublicense, and/or sell copies of the Software, and to     */
/* permit persons to whom the Software is furnished to do so, subject to  */
/* the following conditions:                                              */
/*                                                                        */
/* The above copyright notice and this permission notice shall be         */
/* included in all copies or substantial portions of the Software.        */
/*                                                                        */
/* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,        */
/* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF     */
/* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. */
/* IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY   */
/* CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,   */
/* TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE      */
/* SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                 */
/**************************************************************************/

#ifndef DISABLE_DEPRECATED

#include "core/variant/typed_array.h"

TypedArray&lt;Vector2i&gt; AStarGrid2D::_get_id_path_bind_compat_88047(const Vector2i &amp;p_from_id, const Vector2i &amp;p_to_id) {
    return get_id_path(p_from_id, p_to_id, false);
}

Vector&lt;Vector2&gt; AStarGrid2D::_get_point_path_bind_compat_88047(const Vector2i &amp;p_from_id, const Vector2i &amp;p_to_id) {
    return get_point_path(p_from_id, p_to_id, false);
}

void AStarGrid2D::_bind_compatibility_methods() {
    ClassDB::bind_compatibility_method(D_METHOD("get_id_path", "from_id", "to_id"), &amp;AStarGrid2D::_get_id_path_bind_compat_88047);
    ClassDB::bind_compatibility_method(D_METHOD("get_point_path", "from_id", "to_id"), &amp;AStarGrid2D::_get_point_path_bind_compat_88047);
}

#endif // DISABLE_DEPRECATED</literal_block>
            </container>
            <paragraph>Unless the change in compatibility is complex, the compatibility method should call the modified method directly,
                instead of duplicating that method. Make sure to match the default arguments for that method (in the example above this would be <literal>false</literal>).</paragraph>
            <paragraph>This file should always be placed next to the original file, and have <literal>.compat.inc</literal> at the end instead of <literal>.cpp</literal> or <literal>.h</literal>.
                Next, this should be included in the <literal>.cpp</literal> file we're adding compatibility methods to, so <literal>core/math/a_star_grid_2d.cpp</literal>:</paragraph>
            <container classes="literal-block-wrapper" ids="id2" literal_block="True">
                <caption>core/math/a_star_grid_2d.cpp</caption>
                <literal_block force="False" highlight_args="{}" language="cpp" linenos="False" xml:space="preserve">#include "a_star_grid_2d.h"
#include "a_star_grid_2d.compat.inc"

#include "core/variant/typed_array.h"</literal_block>
            </container>
            <paragraph>Finally, the GDExtension API changes need to be recorded. To do this, first compile Godot on the <literal>master</literal> branch, and
                then run it with the <literal>--dump-extension-api</literal> flag:</paragraph>
            <literal_block force="False" highlight_args="{}" language="shell" linenos="False" xml:space="preserve">git switch master
scons
godot --dump-extension-api</literal_block>
            <paragraph>This will create a file named <literal>extension_api.json</literal> in your current directory. Switch to your feature branch, recompile Godot,
                and then run it with the <literal>--validate-extension-api</literal> flag followed by the path to the <literal>extension_api.json</literal> file you just generated:</paragraph>
            <literal_block force="False" highlight_args="{}" language="shell" linenos="False" xml:space="preserve">git switch my-feature-branch
scons
godot --validate-extension-api /path/to/extension_api.json</literal_block>
            <paragraph>This will generate some lines starting with <literal>Validate extension JSON</literal> like so:</paragraph>
            <literal_block force="False" highlight_args="{}" language="text" linenos="False" xml:space="preserve">Validate extension JSON: Error: Field 'classes/AStar2D/methods/get_id_path/arguments': size changed value in new API, from 2 to 3.
Validate extension JSON: Error: Field 'classes/AStar2D/methods/get_point_path/arguments': size changed value in new API, from 2 to 3.
Validate extension JSON: Error: Field 'classes/AStar3D/methods/get_id_path/arguments': size changed value in new API, from 2 to 3.
Validate extension JSON: Error: Field 'classes/AStar3D/methods/get_point_path/arguments': size changed value in new API, from 2 to 3.
Validate extension JSON: Error: Field 'classes/AStarGrid2D/methods/get_id_path/arguments': size changed value in new API, from 2 to 3.
Validate extension JSON: Error: Field 'classes/AStarGrid2D/methods/get_point_path/arguments': size changed value in new API, from 2 to 3.</literal_block>
            <attention>
                <paragraph>If you get a <literal>Hash changed</literal> error for a method, it means that the compatibility binding is missing or incorrect.
                    Such lines shouldn't be added to the validation file, but fixed by binding the proper compatibility method.
                    Make sure to double-check the following:</paragraph>
                <bullet_list bullet="-">
                    <list_item>
                        <paragraph>For the compatibility method (the one whose name ends with the PR number), the argument types, names, and default
                            values must be identical to the version of the method from before your changes.</paragraph>
                    </list_item>
                    <list_item>
                        <paragraph>In <literal>_bind_compatibility_methods()</literal>, argument names provided to the <literal>D_METHOD()</literal> macro in <literal>ClassDB::bind_compatibility_method()</literal>
                            must be identical to those from the <literal>ClassDB::bind_method()</literal> call for the original method.</paragraph>
                    </list_item>
                </bullet_list>
            </attention>
            <paragraph>Add these lines, followed by a comment explaining what the API change was and the actions taken to prevent breakage,
                to a validation file named after the GitHub pull request ID and placed in the folder of the Godot version it would have broken compatibility for.</paragraph>
            <paragraph>Since this example was for PR #88047, its file name would be <literal>GH-88047.txt</literal>, and because this was done during
                the development of 4.3 (thus changing from 4.2), the file would be in the <literal>misc/extension_api_validation/4.2-stable/</literal> folder.</paragraph>
            <paragraph>See below for a complete example of such a file for this PR:</paragraph>
            <container classes="literal-block-wrapper" ids="id3" literal_block="True">
                <caption>misc/extension_api_validation/4.2-stable/GH-88047.txt</caption>
                <literal_block force="False" highlight_args="{}" language="text" linenos="False" xml:space="preserve">GH-88047
--------
Validate extension JSON: Error: Field 'classes/AStar2D/methods/get_id_path/arguments': size changed value in new API, from 2 to 3.
Validate extension JSON: Error: Field 'classes/AStar2D/methods/get_point_path/arguments': size changed value in new API, from 2 to 3.
Validate extension JSON: Error: Field 'classes/AStar3D/methods/get_id_path/arguments': size changed value in new API, from 2 to 3.
Validate extension JSON: Error: Field 'classes/AStar3D/methods/get_point_path/arguments': size changed value in new API, from 2 to 3.
Validate extension JSON: Error: Field 'classes/AStarGrid2D/methods/get_id_path/arguments': size changed value in new API, from 2 to 3.
Validate extension JSON: Error: Field 'classes/AStarGrid2D/methods/get_point_path/arguments': size changed value in new API, from 2 to 3.

Added optional "allow_partial_path" argument to get_id_path and get_point_path methods in AStar classes.
Compatibility methods registered.</literal_block>
            </container>
            <paragraph>And that's it! You might run into a bit more complicated cases, like rearranging arguments,
                changing return types, etc., but this covers the basics on how to use this system.</paragraph>
            <paragraph>For more information, see <reference name="pull request #76446" refuri="https://github.com/godotengine/godot/pull/76446">pull request #76446</reference><target ids="pull-request-76446" names="pull\ request\ #76446" refuri="https://github.com/godotengine/godot/pull/76446"></target>.</paragraph>
            <substitution_definition names="weblate_widget"><reference refuri="https://hosted.weblate.org/engage/godot-engine/?utm_source=widget"><image alt="Translation status" candidates="{'?': 'https://hosted.weblate.org/widgets/godot-engine/-/godot-docs/287x66-white.png'}" height="66" uri="https://hosted.weblate.org/widgets/godot-engine/-/godot-docs/287x66-white.png" width="287"></image></reference></substitution_definition>
        </section>
    </section>
</document>
